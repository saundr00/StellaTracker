<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StellaTracker</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#ffffff">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 0; background: #fafafa; color: #111; }
    header { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #eee; padding: 12px 16px; display:flex; gap:12px; align-items:center; }
    header img { width: 28px; height: 28px; border-radius: 6px; background:#ddd; }
    h1 { font-size: 18px; margin: 0; }
    main { padding: 16px; display:grid; gap: 16px; max-width: 900px; margin: 0 auto; }
    .card { background: #fff; border: 1px solid #eee; border-radius: 12px; padding: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    label { font-size: 14px; display:block; margin: 6px 0; }
    input, select, textarea, button { font-size: 16px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; background:#fff;}
    button { cursor: pointer; border-color: #ccc; }
    .grid { display:grid; gap:8px; }
    .muted { color:#666; font-size:12px; }
    .entries { display:grid; gap:8px; }
    .entry { padding:10px; border:1px solid #eee; border-radius:8px; background:#fff; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#efefef; margin-right:6px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .space { height:4px; }
    .danger { color:#b00020; }
    .iconbtn { border: none; background: transparent; cursor: pointer; font-size: 16px; padding: 4px 6px; }
    .preset { padding:8px 10px; border:1px solid #ddd; border-radius:999px; background:#f7f7f7; }
  </style>
</head>
<body>
  <header>
    <img alt="logo" />
    <h1>StellaTracker</h1>
  </header>
  <main>
    <section class="card">
      <h2 style="margin:0 0 8px 0;">Quick Presets</h2>
      <div class="flex" id="presets"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0;">Add Log Entry</h2>
      <div class="grid">
        <div class="row">
          <div>
            <label for="metric">Metric</label>
            <select id="metric"></select>
          </div>
          <div>
            <label for="value">Value</label>
            <input id="value" placeholder="e.g., duration 10min, dose 250mg, distance 0.1mi…" />
          </div>
        </div>

        <div class="row" id="accidentRow" style="display:none;">
          <div>
            <label for="location">Accident Location</label>
            <select id="location">
              <option value="">(none)</option>
              <option value="bed">Bed</option>
              <option value="couch">Couch</option>
              <option value="deck">Deck</option>
              <option value="yard">Yard</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <label for="severity">Severity/Size (optional)</label>
            <input id="severity" placeholder="e.g., small/medium/large" />
          </div>
        </div>

        <div id="energyRow" style="display:none;">
          <label for="energy">Energy Level</label>
          <input id="energy" type="range" min="0" max="5" step="1" value="3">
        </div>

        <label for="note">Note (optional)</label>
        <textarea id="note" rows="2" placeholder="Short note…"></textarea>
        <div class="row">
          <div>
            <label for="ts">Time</label>
            <input id="ts" type="datetime-local" />
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button id="saveBtn">Save Entry</button>
            <button id="flushBtn">Sync Pending</button>
          </div>
        </div>
        <div class="muted">Works offline. If the network fails, entries are queued and will sync when you tap <b>Sync Pending</b> or come back online.</div>
      </div>
    </section>

    <section class="card">
      <div class="flex" style="justify-content:space-between;">
        <h2 style="margin:0;">Today</h2>
        <div class="flex">
          <button id="refreshBtn">Refresh</button>
          <button id="exportBtn">Export CSV</button>
        </div>
      </div>
      <div id="todayCounts" class="grid muted"></div>
      <div class="space"></div>
      <div id="entries" class="entries"></div>
    </section>
  </main>

  <script>
    const apiBase = "/api"; // SWA managed functions
    const pendingKey = "st_pending_entries";

    const metricEl = document.getElementById("metric");
    const valueEl = document.getElementById("value");
    const noteEl = document.getElementById("note");
    const tsEl = document.getElementById("ts");
    const entriesEl = document.getElementById("entries");
    const todayCountsEl = document.getElementById("todayCounts");
    const saveBtn = document.getElementById("saveBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");
    const flushBtn = document.getElementById("flushBtn");
    const presetsEl = document.getElementById("presets");
    const accidentRow = document.getElementById("accidentRow");
    const energyRow = document.getElementById("energyRow");
    const energySlider = document.getElementById("energy");
    const locationEl = document.getElementById("location");
    const severityEl = document.getElementById("severity");

    function setNow() {
      const now = new Date();
      const tzOffset = now.getTimezoneOffset();
      const local = new Date(now.getTime() - tzOffset*60000);
      tsEl.value = local.toISOString().slice(0,16);
    }

    // --- Dynamic config (external) ---
    /**
     * Expected /config.json schema:
     * {
     *   "metrics": [
     *     { "id": "stand_assisted", "label": "Stand (Assisted)" },
     *     { "id": "stand_unassisted", "label": "Stand (Unassisted)" },
     *     { "id": "drink", "label": "Drink Water" },
     *     { "id": "eat", "label": "Eat" },
     *     { "id": "panting", "label": "Panting Episode" },
     *     { "id": "tylenol", "label": "Tylenol Given" },
     *     { "id": "bm_normal", "label": "BM (Normal)" },
     *     { "id": "bm_loose", "label": "BM (Loose)" },
     *     { "id": "bm_diarrhea", "label": "BM (Diarrhea)" },
     *     { "id": "bm_accident", "label": "BM Accident", "showAccidentExtras": true },
     *     { "id": "urinate_normal", "label": "Urinate (Normal)" },
     *     { "id": "urinate_accident", "label": "Urinate Accident", "showAccidentExtras": true },
     *     { "id": "assisi_session", "label": "Assisi Loop Session" },
     *     { "id": "walk_inside_assisted", "label": "Walk: Inside (Assisted)" },
     *     { "id": "walk_inside_unassisted", "label": "Walk: Inside (Unassisted)" },
     *     { "id": "walk_circle", "label": "Walk: To Circle" },
     *     { "id": "walk_little_loop", "label": "Walk: Little Loop" },
     *     { "id": "walk_front_yard", "label": "Walk: Front Yard" },
     *     { "id": "walk_back_yard", "label": "Walk: Back Yard" },
     *     { "id": "walk_other", "label": "Walk: Other" },
     *     { "id": "energy", "label": "Energy Level (0-5)", "energyScale": { "min": 0, "max": 5, "step": 1, "default": 3 } },
     *     { "id": "pain_flag", "label": "Pain Flag" },
     *     { "id": "notes", "label": "Notes" }
     *   ],
     *   "presets": [
     *     { "label": "+1 Stand (Unassisted)",       "metric": "stand_unassisted",      "value": "+1", "note": "" },
     *     { "label": "+1 Walk Inside (Unassisted)", "metric": "walk_inside_unassisted", "value": "+1", "note": "" },
     *     { "label": "+1 Panting",                   "metric": "panting",               "value": "+1", "note": "" },
     *     { "label": "+1 Drink Water",               "metric": "drink",                 "value": "+1", "note": "" }
     *   ]
     * }
     */
    let CONFIG = null;
    let metricMap = new Map();

    async function loadConfig() {
      try {
        const res = await fetch('/config.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Config fetch failed');
        CONFIG = await res.json();
      } catch (err) {
        console.warn('Falling back to built-in defaults because /config.json was not found or failed to load.', err);
        CONFIG = {
          metrics: [
            { id: 'stand_assisted', label: 'Stand (Assisted)' },
            { id: 'stand_unassisted', label: 'Stand (Unassisted)' },
            { id: 'drink', label: 'Drink Water' },
            { id: 'eat', label: 'Eat' },
            { id: 'panting', label: 'Panting Episode' },
            { id: 'tylenol', label: 'Tylenol Given' },
            { id: 'bm_normal', label: 'BM (Normal)' },
            { id: 'bm_loose', label: 'BM (Loose)' },
            { id: 'bm_diarrhea', label: 'BM (Diarrhea)' },
            { id: 'bm_accident', label: 'BM Accident', showAccidentExtras: true },
            { id: 'urinate_normal', label: 'Urinate (Normal)' },
            { id: 'urinate_accident', label: 'Urinate Accident', showAccidentExtras: true },
            { id: 'assisi_session', label: 'Assisi Loop Session' },
            { id: 'walk_inside_assisted', label: 'Walk: Inside (Assisted)' },
            { id: 'walk_inside_unassisted', label: 'Walk: Inside (Unassisted)' },
            { id: 'walk_circle', label: 'Walk: To Circle' },
            { id: 'walk_little_loop', label: 'Walk: Little Loop' },
            { id: 'walk_front_yard', label: 'Walk: Front Yard' },
            { id: 'walk_back_yard', label: 'Walk: Back Yard' },
            { id: 'walk_other', label: 'Walk: Other' },
            { id: 'energy', label: 'Energy Level (0-5)', energyScale: { min: 0, max: 5, step: 1, default: 3 } },
            { id: 'pain_flag', label: 'Pain Flag' },
            { id: 'notes', label: 'Notes' }
          ],
          presets: [
            { label: '+1 Stand (Unassisted)',       metric: 'stand_unassisted',      value: '+1', note: '' },
            { label: '+1 Walk Inside (Unassisted)', metric: 'walk_inside_unassisted', value: '+1', note: '' },
            { label: '+1 Panting',                   metric: 'panting',               value: '+1', note: '' },
            { label: '+1 Drink Water',               metric: 'drink',                 value: '+1', note: '' }
          ]
        };
      }
      metricMap = new Map(CONFIG.metrics.map(m => [m.id, m]));
      buildMetricSelect();
      buildPresets();
      onMetricChange();
    }

    function buildMetricSelect() {
      metricEl.innerHTML = '';
      for (const m of CONFIG.metrics) {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.label;
        metricEl.appendChild(opt);
      }
    }

    function buildPresets() {
      presetsEl.innerHTML = '';
      for (const p of (CONFIG.presets || [])) {
        const btn = document.createElement('button');
        btn.className = 'preset';
        btn.dataset.metric = p.metric;
        if (p.value != null) btn.dataset.value = String(p.value);
        if (p.note != null) btn.dataset.note = String(p.note);
        btn.textContent = p.label;
        presetsEl.appendChild(btn);
      }
    }

    setNow();
    loadConfig();

    metricEl.addEventListener("change", onMetricChange);
    function onMetricChange() {
      const id = metricEl.value;
      const def = metricMap.get(id) || {};
      // Accident-specific extras come from config
      accidentRow.style.display = def.showAccidentExtras ? '' : 'none';
      // Energy slider driven by config
      if (def.energyScale) {
        energyRow.style.display = '';
        energySlider.min = def.energyScale.min ?? 0;
        energySlider.max = def.energyScale.max ?? 5;
        energySlider.step = def.energyScale.step ?? 1;
        if (!valueEl.value) {
          energySlider.value = String(def.energyScale.default ?? 3);
          valueEl.value = String(def.energyScale.default ?? 3);
        }
      } else {
        energyRow.style.display = 'none';
      }
    }

    presetsEl.addEventListener("click", (e) => {
      const btn = e.target.closest("button.preset");
      if (!btn) return;
      metricEl.value = btn.dataset.metric;
      valueEl.value = btn.dataset.value || "";
      noteEl.value = btn.dataset.note || "";
      onMetricChange();
      saveEntry();
    });

    function fmtDate(s) {
      const d = new Date(s);
      return d.toLocaleString();
    }
    function pill(label) {
      const span = document.createElement("span");
      span.className = "pill";
      span.textContent = label;
      return span;
    }

    function loadPending() {
      try {
        return JSON.parse(localStorage.getItem(pendingKey) || "[]");
      } catch { return []; }
    }
    function savePending(arr) {
      localStorage.setItem(pendingKey, JSON.stringify(arr));
    }
    async function flushPending() {
      const queue = loadPending();
      if (!queue.length) return;
      const remain = [];
      for (const body of queue) {
        try {
          const res = await fetch(`${apiBase}/entry`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
          });
          if (!res.ok) throw new Error("fail");
        } catch {
          remain.push(body);
        }
      }
      savePending(remain);
      await refresh();
      alert(remain.length ? `Synced ${queue.length - remain.length}, ${remain.length} left` : `All pending entries synced`);
    }
    window.addEventListener("online", flushPending);
    setInterval(flushPending, 30000);

    async function saveEntry() {
      const metric = metricEl.value;
      let value = valueEl.value || '';
      const noteParts = [];
      const def = metricMap.get(metric) || {};
      if (def.energyScale) {
        value = energySlider.value;
      }
      if (def.showAccidentExtras) {
        if (locationEl.value) noteParts.push(`location:${locationEl.value}`);
        if (severityEl.value) noteParts.push(`size:${severityEl.value}`);
      }
      const extra = noteParts.join(' ');
      const note = [noteEl.value || '', extra].filter(Boolean).join(' ').trim();
      const localIso = new Date(tsEl.value).toISOString();
      const body = { metric, value, note, ts: localIso };

      try {
        const res = await fetch(`${apiBase}/entry`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("save failed");
      } catch {
        // queue offline
        const q = loadPending();
        q.push(body);
        savePending(q);
      }
      valueEl.value = "";
      noteEl.value = "";
      locationEl.value = "";
      severityEl.value = "";
      setNow();
      await refresh();
    }

    async function deleteEntry(partitionKey, rowKey) {
      if (!confirm("Delete this entry?")) return;
      const res = await fetch(`${apiBase}/entry/${encodeURIComponent(partitionKey)}/${encodeURIComponent(rowKey)}`, {
        method: "DELETE"
      });
      if (!res.ok) {
        alert("Failed to delete.");
        return;
      }
      await refresh();
    }

    function summarizeToday(entries) {
      const start = new Date(); start.setHours(0,0,0,0);
      const end = new Date(); end.setHours(23,59,59,999);
      const today = entries.filter(e => {
        const t = new Date(e.ts);
        return t >= start && t <= end;
      });
      const counts = {};
      for (const e of today) {
        counts[e.metric] = (counts[e.metric] || 0) + 1;
      }
      todayCountsEl.innerHTML = "";
      const keys = Object.keys(counts).sort();
      if (keys.length === 0) {
        const div = document.createElement("div");
        div.textContent = "No entries yet today.";
        todayCountsEl.appendChild(div);
      } else {
        for (const k of keys) {
          const div = document.createElement("div");
          div.textContent = `${k}: ${counts[k]}`;
          todayCountsEl.appendChild(div);
        }
      }
    }

    async function refresh() {
      const params = new URLSearchParams();
      const now = new Date();
      const start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
      params.set("from", start.toISOString());
      params.set("to", now.toISOString());
      const res = await fetch(`${apiBase}/entries?${params.toString()}`);
      if (!res.ok) { entriesEl.innerHTML = "<div class='muted'>Failed to load.</div>"; return; }
      const data = await res.json();
      entriesEl.innerHTML = "";
      summarizeToday(data.items || []);
      (data.items || []).sort((a,b) => a.ts > b.ts ? -1 : 1).forEach(e => {
        const div = document.createElement("div");
        div.className = "entry";
        const h = document.createElement("div");
        h.appendChild(pill(e.metric));
        if (e.value) h.appendChild(pill(e.value));
        div.appendChild(h);
        const t = document.createElement("div");
        t.className = "muted";
        t.textContent = fmtDate(e.ts);
        div.appendChild(t);
        if (e.note) {
          const n = document.createElement("div");
          n.textContent = e.note;
          div.appendChild(n);
        }
        const actions = document.createElement("div");
        actions.className = "flex";
        const del = document.createElement("button");
        del.className = "iconbtn danger";
        del.textContent = "Delete";
        del.addEventListener("click", () => deleteEntry(e.partitionKey, e.id));
        actions.appendChild(del);
        div.appendChild(actions);
        entriesEl.appendChild(div);
      });
    }

    saveBtn.addEventListener("click", saveEntry);
    refreshBtn.addEventListener("click", refresh);
    exportBtn.addEventListener("click", async () => {
      const res = await fetch(`${apiBase}/export?days=30`);
      if (!res.ok) { alert("Failed to export"); return; }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "stella_export.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
    flushBtn.addEventListener("click", flushPending);

    refresh();
  </script>
</body>
</html>
